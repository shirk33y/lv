name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (default: read from Cargo.toml)"
        required: false
      prerelease:
        description: "Mark as prerelease"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # ── Resolve version (shared by all jobs) ─────────────────────────────
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version
        id: ver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            V="${{ inputs.version }}"
          else
            V=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            V="${V}-$(date -u +%Y%m%dT%H%M%S)-${SHORT_SHA}"
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "Releasing v$V"
          {
            echo "## Release v$V"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| **Version** | \`$V\` |"
            echo "| **Prerelease** | ${{ inputs.prerelease }} |"
            echo "| **Commit** | \`$(git rev-parse --short HEAD)\` |"
            echo "| **Source** | ${{ inputs.version && 'manual input' || 'Cargo.toml' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Linux build + package (Docker multi-stage) ───────────────────────
  build-linux:
    needs: resolve-version
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build + smoke test
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.linux-x86_64
          target: smoke
          push: false
          cache-from: type=gha,scope=linux-x86_64
          cache-to: type=gha,mode=max,scope=linux-x86_64
          github-token: ${{ github.token }}

      - name: Extract artifacts
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.linux-x86_64
          target: out
          push: false
          outputs: type=local,dest=dist-linux
          cache-from: type=gha,scope=linux-x86_64
          github-token: ${{ github.token }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: dist-linux/

  # ── Windows cross-compile + package (Docker multi-stage) ─────────────
  build-windows:
    needs: resolve-version
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build + smoke test
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.windows-x86_64
          target: smoke
          push: false
          cache-from: type=gha,scope=windows-x86_64
          cache-to: type=gha,mode=max,scope=windows-x86_64
          github-token: ${{ github.token }}

      - name: Extract artifacts
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.windows-x86_64
          target: out
          push: false
          outputs: type=local,dest=dist-windows
          cache-from: type=gha,scope=windows-x86_64
          github-token: ${{ github.token }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: dist-windows/

  # ── Publish release ──────────────────────────────────────────────────
  publish:
    needs: [resolve-version, build-linux, build-windows]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve-version.outputs.version }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        run: |
          FLAGS="--title v$VERSION --generate-notes"
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            FLAGS="$FLAGS --prerelease"
          fi
          gh release create "v$VERSION" $FLAGS

      - name: Upload assets
        run: |
          find artifacts/release-linux -type f | xargs gh release upload "v$VERSION"
          find artifacts/release-windows -type f | xargs gh release upload "v$VERSION"

      - name: Summary
        run: |
          LINUX=$(find artifacts/release-linux -type f -printf '%f\n' | head -5)
          WINDOWS=$(find artifacts/release-windows -type f -printf '%f\n' | head -5)
          REPO="https://github.com/${{ github.repository }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          {
            echo "## Published v$VERSION"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| **Release** | [$REPO/releases/tag/v$VERSION]($REPO/releases/tag/v$VERSION) |"
            echo "| **Tag** | [\`v$VERSION\`]($REPO/tree/v$VERSION) |"
            echo "| **Commit** | [\`$SHORT_SHA\`]($REPO/commit/$SHA) |"
            echo ""
            echo "### Artifacts"
            echo "#### Linux"
            for f in $LINUX; do echo "- \`$f\`"; done
            echo "#### Windows"
            for f in $WINDOWS; do echo "- \`$f\`"; done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Bump patch version
        if: ${{ inputs.prerelease != true }}
        run: |
          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)
          NEXT="${MAJOR}.${MINOR}.$((PATCH + 1))"
          sed -i "0,/^version = \".*\"/s//version = \"$NEXT\"/" Cargo.toml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml
          git commit -m "chore: bump version to $NEXT [skip ci]"
          git push
