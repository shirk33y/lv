name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (default: read from Cargo.toml)"
        required: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version
        id: ver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            V="${{ inputs.version }}"
          else
            V=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "Releasing v$V"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: "true"

      # ── Linux build ──────────────────────────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev libmpv-dev llvm clang nsis

      - name: Build (Linux)
        run: cargo build --release

      - name: Package AppImage (Linux x86_64)
        run: LV_VERSION=${{ steps.ver.outputs.version }} bash pkg/appimage.sh x86_64

      # ── Windows cross-compile ────────────────────────────────────────
      - name: Cache cargo-xwin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-xwin
          key: cargo-xwin-${{ runner.os }}
          restore-keys: cargo-xwin-

      - name: Cache xwin MSVC CRT/SDK
        uses: actions/cache@v4
        with:
          path: ~/.cache/cargo-xwin
          key: xwin-msvc-sdk

      - name: Install cargo-xwin
        run: which cargo-xwin || cargo install cargo-xwin --locked

      - name: Build (Windows)
        run: cargo xwin build --release --target x86_64-pc-windows-msvc

      - name: Package installer (Windows)
        run: |
          mkdir -p build-installer
          cp target/x86_64-pc-windows-msvc/release/lv.exe build-installer/
          cp pkg/win64/SDL2.dll build-installer/
          cp pkg/win64/libmpv-2.dll build-installer/
          cp pkg/installer.nsi build-installer/
          cd build-installer
          makensis -DLV_VERSION=${{ steps.ver.outputs.version }} installer.nsi

      # ── Create release + upload assets ──────────────────────────────
      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: gh release create "v$VERSION" --title "v$VERSION" --generate-notes

      - name: Upload AppImage
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: gh release upload "v$VERSION" lv-*-x86_64.AppImage

      - name: Upload Windows installer
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: gh release upload "v$VERSION" build-installer/lv-setup-*.exe

      - name: Upload Windows binary
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          cp build-installer/lv.exe "lv-${VERSION}-x86_64-windows.exe"
          gh release upload "v$VERSION" "lv-${VERSION}-x86_64-windows.exe"
