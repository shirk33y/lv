name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (default: read from Cargo.toml)"
        required: false
      prerelease:
        description: "Mark as prerelease"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # ── Resolve version (shared by all jobs) ─────────────────────────────
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version
        id: ver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            V="${{ inputs.version }}"
          else
            V=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            V="${V}-$(date -u +%Y%m%dT%H%M%S)-${SHORT_SHA}"
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "Releasing v$V"
          {
            echo "## Release v$V"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| **Version** | \`$V\` |"
            echo "| **Prerelease** | ${{ inputs.prerelease }} |"
            echo "| **Commit** | \`$(git rev-parse --short HEAD)\` |"
            echo "| **Source** | ${{ inputs.version && 'manual input' || 'Cargo.toml' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Linux build + package ────────────────────────────────────────────
  build-linux:
    needs: resolve-version
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: "true"
          shared-key: "release-build"

      - name: Install system dependencies
        uses: eclipse-score/apt-install@bd30e2e74a4850389719cb8c3e312bb26aada4e0
        with:
          packages: libsdl2-dev libmpv-dev

      - name: Build
        run: cargo build --release

      - name: Package AppImage
        run: LV_VERSION=$VERSION bash pkg/appimage.sh x86_64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: lv-*-x86_64.AppImage

  # ── Windows cross-compile + package ──────────────────────────────────
  build-windows:
    needs: resolve-version
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: "true"

      - name: Install system dependencies
        uses: eclipse-score/apt-install@bd30e2e74a4850389719cb8c3e312bb26aada4e0
        with:
          packages: llvm clang libsdl2-dev libmpv-dev nsis

      - name: Cache cargo-xwin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-xwin
          key: cargo-xwin-${{ runner.os }}
          restore-keys: cargo-xwin-

      - name: Cache xwin MSVC CRT/SDK
        uses: actions/cache@v4
        with:
          path: ~/.cache/cargo-xwin
          key: xwin-msvc-sdk

      - name: Install cargo-xwin
        run: which cargo-xwin || cargo install cargo-xwin --locked

      - name: Build
        run: cargo xwin build --release --target x86_64-pc-windows-msvc

      - name: Package installer
        run: |
          mkdir -p build-installer
          cp target/x86_64-pc-windows-msvc/release/lv.exe build-installer/
          cp pkg/win64/SDL2.dll build-installer/
          cp pkg/win64/libmpv-2.dll build-installer/
          cp pkg/win64/lv.ico build-installer/
          cp pkg/installer.nsi build-installer/
          cd build-installer
          makensis -DLV_VERSION=$VERSION installer.nsi

      - name: Rename standalone binary
        run: cp target/x86_64-pc-windows-msvc/release/lv.exe "lv-${VERSION}-x86_64-windows.exe"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            build-installer/lv-setup-*.exe
            lv-*-x86_64-windows.exe

      - name: Upload binary + DLLs (for smoke test)
        uses: actions/upload-artifact@v4
        with:
          name: windows-bin
          path: |
            build-installer/lv.exe
            build-installer/SDL2.dll
            build-installer/libmpv-2.dll

  # ── Smoke tests (gate the release) ────────────────────────────────────
  smoke-test-linux:
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install test tools
        uses: eclipse-score/apt-install@bd30e2e74a4850389719cb8c3e312bb26aada4e0
        with:
          packages: xvfb xdotool graphicsmagick-imagemagick-compat

      - name: Download AppImage
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: .

      - name: Make AppImage executable
        run: chmod +x lv-*.AppImage

      - name: Generate test fixtures
        run: python3 test/fixtures/generate.py

      - name: Run smoke test
        run: xvfb-run -a bash scripts/smoke-test.sh --binary ./lv-*.AppImage --update-reference
        env:
          APPIMAGE_EXTRACT_AND_RUN: "1"

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshots-linux
          path: test/screenshots/actual/

  smoke-test-windows:
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Wine and test tools
        run: sudo dpkg --add-architecture i386

      - name: Install Wine and test packages
        uses: eclipse-score/apt-install@bd30e2e74a4850389719cb8c3e312bb26aada4e0
        with:
          packages: xvfb wine64 xdotool graphicsmagick-imagemagick-compat
          apt_update: true

      - name: Download Windows binary + DLLs
        uses: actions/download-artifact@v4
        with:
          name: windows-bin
          path: win-bin

      - name: Generate test fixtures
        run: python3 test/fixtures/generate.py

      - name: Run smoke test (Wine)
        run: xvfb-run -a bash scripts/smoke-test.sh --binary win-bin/lv.exe --wine --update-reference

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshots-windows
          path: test/screenshots/actual/

  # ── Create release + upload ──────────────────────────────────────────
  publish:
    needs: [resolve-version, smoke-test-linux, smoke-test-windows]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.resolve-version.outputs.version }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        run: |
          FLAGS="--title v$VERSION --generate-notes"
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            FLAGS="$FLAGS --prerelease"
          fi
          gh release create "v$VERSION" $FLAGS

      - name: Upload assets
        run: gh release upload "v$VERSION" artifacts/release-linux/* artifacts/release-windows/*

      - name: Summary
        run: |
          LINUX=$(ls artifacts/release-linux/ | head -5)
          WINDOWS=$(ls artifacts/release-windows/ | head -5)
          REPO="https://github.com/${{ github.repository }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          {
            echo "## Published v$VERSION"
            echo ""
            echo "| | |"
            echo "|---|---|"
            echo "| **Release** | [$REPO/releases/tag/v$VERSION]($REPO/releases/tag/v$VERSION) |"
            echo "| **Tag** | [\`v$VERSION\`]($REPO/tree/v$VERSION) |"
            echo "| **Commit** | [\`$SHORT_SHA\`]($REPO/commit/$SHA) |"
            echo ""
            echo "### Artifacts"
            echo "#### Linux"
            for f in $LINUX; do echo "- \`$f\`"; done
            echo "#### Windows"
            for f in $WINDOWS; do echo "- \`$f\`"; done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Bump patch version
        if: ${{ inputs.prerelease != true }}
        run: |
          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)
          NEXT="${MAJOR}.${MINOR}.$((PATCH + 1))"
          sed -i "0,/^version = \".*\"/s//version = \"$NEXT\"/" Cargo.toml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml
          git commit -m "chore: bump version to $NEXT [skip ci]"
          git push
